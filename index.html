
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>í™”ì„±ì‹œ & í‰íƒì‹œ ì²´ê°ì˜¨ë„ ì˜ˆë³´</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
 <style>
/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ„ì— ë®ì–´ì“°ê¸° ë˜ëŠ” ë³„ë„ ì•„ë˜ ì¶”ê°€ */
@media (max-width: 768px) {
  body {
    padding: 10px !important;
  }

  canvas {
    width: 120px !important;
    height: 120px !important;
  }

  .chart-row {
    flex-direction: column !important;
    align-items: center !important;
    gap: 10px !important;
  }

  select {
    width: 100% !important;
    margin-top: 5px;
  }

  h1 {
    font-size: 24px !important;
  }

  .description-text {
    font-size: 14px !important;
    text-align: center !important;
    margin-left: 0 !important;
  }

  img {
    max-width: 100% !important;
    height: auto !important;
  }
}
</style>
<script>

window.onload = function() {
    document.getElementById('locationD_P').style.display = "none";
    loadBoth(57, 119);
}

function selectS(loS){
     if(loS == "hwaseong"){
         document.getElementById('locationD_H').style.display = "inline-block";
         document.getElementById('locationD_P').style.display = "none";
         document.getElementById('locationD_H').selectedIndex = 0;
         document.getElementById('locationD_P').selectedIndex = 0;
         loadBoth(57, 119);
     }else if(loS == "pyeongtaek"){
         document.getElementById('locationD_H').style.display = "none";
         document.getElementById('locationD_P').style.display = "inline-block";
         document.getElementById('locationD_H').selectedIndex = 0;
         document.getElementById('locationD_P').selectedIndex = 0;
         loadBoth(62, 114);
     }
}

function selectD(loD){
//   alert(loD.split("_")[0] + "_" + loD.split("_")[1]); 
   loadBoth(loD.split("_")[0], loD.split("_")[1]);
}

</script>

</head>

<body>
<link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
  <h1 style="height:30px; font-size: 40px; font-family: 'Jua', sans-serif;">ğŸŒ¡ë‚´ì¼ ì‹œê°„ëŒ€ë³„ ì²´ê°ì˜¨ë„ ì˜ˆë³´</h1>
  <div id="dateDisplay" style="text-align: center; margin-right:8px; margin-bottom:8px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...   </div>


<div style="">
    <img src="location.png" width="20px" style="vertical-align: middle;"/>
    <select name="locationS" id="locationS" onchange="selectS(this.value);" style="border-radius:4px; border:2px solid #fff; width:120px; height:35px;">
        <option value="hwaseong">í™”ì„±ì‹œ</option>
        <option value="pyeongtaek">í‰íƒì‹œ</option>
    </select>

    <select name="locationD_H" id="locationD_H" onchange="selectD(this.value);" style="border-radius:4px; border:2px solid #fff; width:150px; height:35px;">
        <option value="57_119"></option>
        <option value="59_119">ë´‰ë‹´ì</option>
        <option value="57_116">ìš°ì •ì</option>
        <option value="59_117">í–¥ë‚¨ì</option>
        <option value="57_119">ë‚¨ì–‘ì</option>
        <option value="59_120">ë§¤ì†¡ë©´</option>
        <option value="58_119">ë¹„ë´‰ë©´</option>
        <option value="56_119">ë§ˆë„ë©´</option>
        <option value="56_119">ì†¡ì‚°ë©´</option>
        <option value="55_118">ì„œì‹ ë©´</option>
        <option value="59_118">íŒ”íƒ„ë©´</option>
        <option value="57_116">ì¥ì•ˆë©´</option>
        <option value="59_116">ì–‘ê°ë©´</option>
        <option value="60_118">ì •ë‚¨ë©´</option>
        <option value="57_121">ìƒˆì†”ë™</option>
        <option value="61_119">ì§„ì•ˆë™</option>
        <option value="61_119">ë³‘ì 1ë™</option>
        <option value="61_119">ë³‘ì 2ë™</option>
        <option value="61_119">ë°˜ì›”ë™</option>
        <option value="60_119">ê¸°ë°°ë™</option>
        <option value="61_119">í™”ì‚°ë™</option>
        <option value="62_119">ë™íƒ„1ë™</option>
        <option value="62_119">ë™íƒ„2ë™</option>
        <option value="61_119">ë™íƒ„3ë™</option>
        <option value="62_119">ë™íƒ„4ë™</option>
        <option value="62_119">ë™íƒ„5ë™</option>
        <option value="62_118">ë™íƒ„6ë™</option>
        <option value="62_118">ë™íƒ„7ë™</option>
        <option value="62_118">ë™íƒ„8ë™</option>
        <option value="63_118">ë™íƒ„9ë™</option>
    </select>

    <select name="locationD_P" id="locationD_P" onchange="selectD(this.value);" style="border-radius:4px; border:2px solid #fff; width:150px; height:35px;">
        <option value="62_114"></option>
        <option value="61_114">íŒ½ì„±ì</option>
        <option value="59_114">ì•ˆì¤‘ì</option>
        <option value="58_114">í¬ìŠ¹ì</option>
        <option value="59_115">ì²­ë¶ì</option>
        <option value="62_117">ì§„ìœ„ë©´</option>
        <option value="61_117">ì„œíƒ„ë©´</option>
        <option value="61_115">ê³ ë•ë©´</option>
        <option value="60_115">ì˜¤ì„±ë©´</option>
        <option value="59_114">í˜„ë•ë©´</option>
        <option value="61_116">ì¤‘ì•™ë™</option>
        <option value="61_116">ì„œì •ë™</option>
        <option value="62_115">ì†¡íƒ„ë™</option>
        <option value="61_116">ì§€ì‚°ë™</option>
        <option value="61_116">ì†¡ë¶ë™</option>
        <option value="61_116">ì‹ ì¥1ë™</option>
        <option value="61_116">ì‹ ì¥2ë™</option>
        <option value="62_114">ì‹ í‰ë™</option>
        <option value="62_114">ì›í‰ë™</option>
        <option value="62_114">í†µë³µë™</option>
        <option value="62_114">ë¹„ì „1ë™</option>
        <option value="62_114">ë¹„ì „2ë™</option>
        <option value="63_114">ìš©ì´ë™</option>
        <option value="62_114">ì„¸êµë™</option>
        <option value="62_115">ë™ì‚­ë™</option>
        <option value="61_115">ê³ ë•ë™</option>
    </select>
</div>

<img src="ë²”ë¡€.png" width="400" height="auto" style="margin-top: 20px;">

<div class="chart-row">
    <div class="chart-row">
	</div>
	<div style="text-align: center; margin-left: 10px;">
	    <canvas id="feelsHwaseong" width="150" height="150"></canvas>
  <div style="margin-top: 10px; font-size: 18px; color: black; text-align: left; max-width: 450px; margin-left: 0px; ">
    â€»  <strong>ì¼ ìµœê³ ì²´ê°ì˜¨ë„</strong>ëŠ” ì‹œê°„ëŒ€ë³„ ì²´ê°ì˜¨ë„ë³´ë‹¤ ë” ë†’ê² ìœ¼ë‹ˆ, <br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ë‹¨ê³„ë³„ ì ê·¹ì ì¸ ëŒ€ë¹„ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>[ì£¼ì˜]</strong> ì•¼ì™¸ì‘ì—…ì€ ê°€ê¸‰ì  ìì œí•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.<br>
   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>[ê²½ê³ ]</strong> ì•¼ì™¸ì‘ì—…ì€ í”¼í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>[ìœ„í—˜]</strong> ì•¼ì™¸ì‘ì—…ì€ ë§¤ìš° ìœ„í—˜í•©ë‹ˆë‹¤.
	    </div>
	</div>

    </div>
</div>        

<div id="dateDisplay" style="text-align: center"><img src="ci.png" width="120px"/></div>


  <script>
    const API_KEY = "4WbcPl8cpZjq8VXOePfsXjYGid7SRm5olpV5s6WVU2qwe6cuzQCFIwqjhf45FV1x0fEtTkZnwFEoLZSG%2B69j6g%3D%3D";
    const API_URL = "https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst";

    const today = new Date();
    const tomorrow = new Date();
    tomorrow.setDate(today.getDate() + 1);

    const baseDate = today.toISOString().slice(0, 10).replace(/-/g, "");
    const targetFcstDate = tomorrow.toISOString().slice(0, 10).replace(/-/g, "");

    const tomorrowDate = tomorrow.toISOString().slice(0, 10).replace(/-/g, "");

//  document.getElementById("dateDisplay").innerText = `ğŸ“… ê¸°ì¤€ì¼: ${baseDate}, ì˜ˆë³´ì¼: ${targetFcstDate}`;  
//    document.getElementById("dateDisplay").innerText = `${baseDate.substr(4, 2)}ì›”${baseDate.substr(6, 2)}ì¼ ë°œí‘œ`;

    document.getElementById("dateDisplay").innerText = baseDate.substr(4, 2) + 'ì›”' + baseDate.substr(6, 2) + 'ì¼ 17ì‹œ ë°œí‘œ';
//    document.getElementById("tomorrowTemp").innerText = tomorrowDate.substr(4, 2) + 'ì›”' + tomorrowDate.substr(6, 2) + 'ì¼ ê¸°ì˜¨';
//    document.getElementById("tomorrowFeels").innerText = tomorrowDate.substr(4, 2) + 'ì›”' + tomorrowDate.substr(6, 2) + 'ì¼ ì²´ê°ê¸°ì˜¨';

    async function fetchForecast(nx, ny) {
      const url = `${API_URL}?serviceKey=${API_KEY}&numOfRows=1000&pageNo=1&dataType=JSON&base_date=${baseDate}&base_time=1700&nx=${nx}&ny=${ny}`;
      const response = await fetch(url);
      const data = await response.json();
      const items = data.response.body.items.item;

      let temps = new Map();
      let humids = new Map();

      items.forEach(item => {
        if (item.fcstDate !== targetFcstDate) return;
        const time = parseInt(item.fcstTime);
        //    alert("time : " + time + " - " + "itme : " + parseFloat(item.fcstValue));
        if (time >= 800 && time <= 2000) {
          if (item.category === "TMP") temps.set(time, parseFloat(item.fcstValue));
          if (item.category === "REH") humids.set(time, parseFloat(item.fcstValue));
        }
      });

      const times = [];
      const tempValues = [];
      const humidValues = [];

      for (let t = 800; t <= 2000; t += 100) {
        if (temps.has(t) && humids.has(t)) {
          times.push(t.toString().padStart(4, "0"));
          tempValues.push(temps.get(t));
          humidValues.push(humids.get(t));
        }
      }

      const feelsLikeValues = tempValues.map((Ta, i) => {
        const RH = humidValues[i];
        const Tw = calculateWetBulbTemperature(Ta, RH);
   return Math.round(calculateFeelsLikeTemperature(Ta, Tw));
      });

      return { times, tempValues, feelsLikeValues };
    }

    function calculateWetBulbTemperature(Ta, RH) {
      return Ta * Math.atan(0.151977 * Math.pow(RH + 8.313659, 0.5))
        + Math.atan(Ta + RH)
        - Math.atan(RH - 1.67633)
        + 0.00391838 * Math.pow(RH, 1.5) * Math.atan(0.023101 * RH)
        - 4.686035;
    }

    function calculateFeelsLikeTemperature(Ta, Tw) {
      return -0.2442 + 0.55399 * Tw + 0.45535 * Ta
        - 0.0022 * Tw * Tw + 0.00278 * Tw * Ta + 3.0;
    }

    function getColor(temp) {

      if (temp >= 35) return "#E0002B";
      if (temp >= 33) return "#EF5D20";
      if (temp >= 31) return "#FFCD12";
      if (temp >= 29) return "#86E57F";
      return "#D5D5D5";
    }

    const labelText = 'text';


function polarChart(ctxId, times, values, labelText) {
  const canvas = document.getElementById(ctxId);
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  if (Chart.getChart(ctxId)) Chart.getChart(ctxId).destroy();

  const extendedTimes = [...times, ''];
  const baseValue = 1;
  const extendedValues = new Array(times.length).fill(baseValue);
  extendedValues.push(0.15);
  const backgroundColors = values.map(getColor);
  backgroundColors.push('rgba(0,0,0,0)');

  // ì¤‘ì•™ í…ìŠ¤íŠ¸ ë° ë‚ ì§œ ì´ë¯¸ì§€
  const centerImageWithTextPlugin = {
    id: "centerImageWithTextPlugin",
    beforeDraw(chart) {
      const { width, height, ctx } = chart;

      const image = new Image();
      image.src = "./calendar.png";

      image.onload = () => {
        const size = 60;
        const x = width / 2 - size / 2;
        const y = height / 2 - size / 2 - 15;

        ctx.save();
        ctx.drawImage(image, x, y, size, size);
        ctx.restore();

        ctx.save();
        ctx.font = "bold 18px Arial";
        ctx.fillStyle = "black";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(labelText[0], width / 2, height / 2 -5);
        ctx.restore();

        ctx.save();
        ctx.font = "bold 18px Arial";
        ctx.fillStyle = "#E0002B";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(labelText[1], width / 2, height / 2 + 25);
        ctx.restore();
      };
    }
  };

  // í…ìŠ¤íŠ¸ ë° ê°•ì¡° ì‚¬ê°í˜•
  const textPlugin = {
    id: "textPlugin",
    afterDraw(chart) {
      const { ctx } = chart;
      const meta = chart.getDatasetMeta(0);
      const realValues = chart.data.datasets[0].realValues;
      ctx.save();

      const highlightHours = ["09", "12", "15", "18"];

      meta.data.forEach((arc, i) => {
        const label = chart.data.labels[i];
        if (!label || label === '') return;

        const radius = arc.outerRadius + 20;
        const angle = (arc.startAngle + arc.endAngle) / 2;

        const x = chart.width / 2 + radius * Math.cos(angle);
        const y = chart.height / 2 + radius * Math.sin(angle);

        const hourOnly = label.slice(0, 2);

        ctx.font = "bold 16px Arial";
        ctx.fillStyle = "black";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(hourOnly + "ì‹œ", x, y);

        const innerCenter = arc.tooltipPosition();
        ctx.fillText(Math.round(realValues[i]) + "â„ƒ", innerCenter.x, innerCenter.y + 4);

 if (highlightHours.includes(hourOnly)) {
  const boxWidth = 35;
  const boxHeight = 25;

  ctx.strokeStyle = "black";
  ctx.lineWidth = 1;
  ctx.strokeRect(
    x - boxWidth / 2,
    y - boxHeight / 2,
    boxWidth,
    boxHeight
  );
}
      });
      ctx.restore();
    }
  };

  return new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: extendedTimes,
      datasets: [{
        data: extendedValues,
        backgroundColor: backgroundColors,
        borderWidth: 1,
        realValues: values
      }]
    },
    options: {
      rotation: 235,
  radius: '90%', 
      cutout: "60%",
      layout: {
        padding: { top: 10, bottom: 10, left: 40, right: 40 }
      },
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false }
      }
    },
    plugins: [textPlugin, centerImageWithTextPlugin]
  });
}

    async function loadBoth(lo, ca) {
    //alert(lo + "_" + ca);
      const hwaseong = await fetchForecast(lo, ca);
  
polarChart(
  "tempHwaseong",
  hwaseong.times,
  hwaseong.tempValues,
  [parseInt(tomorrowDate.substr(4, 2), 10) + '/' + tomorrowDate.substr(6, 2), 'ê¸°ì˜¨' ]
);
polarChart(
  "feelsHwaseong",
  hwaseong.times,
  hwaseong.feelsLikeValues,
  [parseInt(tomorrowDate.substr(4, 2), 10) + '/' + tomorrowDate.substr(6, 2),'ì²´ê°ì˜¨ë„' ]
);

    }
  </script>

<style>
/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ„ì— ë®ì–´ì“°ê¸° ë˜ëŠ” ë³„ë„ ì•„ë˜ ì¶”ê°€ */
@media (max-width: 768px) {
  body {
    padding: 10px !important;
  }

  canvas {
    width: 120px !important;
    height: 120px !important;
  }

  .chart-row {
    flex-direction: column !important;
    align-items: center !important;
    gap: 10px !important;
  }

  select {
    width: 100% !important;
    margin-top: 5px;
  }

  h1 {
    font-size: 24px !important;
  }

  .description-text {
    font-size: 14px !important;
    text-align: center !important;
    margin-left: 0 !important;
  }

  img {
    max-width: 100% !important;
    height: auto !important;
  }
}
</style>



	
</body>
</html>
