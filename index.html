<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>화성시 & 평택시 체감온도 예보</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #F0F8FF;
    }
    h1 {
      font-size: 28px;
      font-family: 'Jua', sans-serif;
    }
    .controls {
      margin: 10px 0;
    }
    .chart-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }
    canvas {
      max-width: 100%;
      height: auto;
    }
    img.legend, img.ci {
      max-width: 100%;
      height: auto;
      margin-top: 20px;
    }
    @media (min-width: 600px) {
      .chart-row {
        display: flex;
        justify-content: center;
        gap: 30px;
      }
    }
  </style>
</head>
<body>
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
  <h1>🌡 내일 시간대별 체감온도 예보</h1>

  <div id="dateDisplay">불러오는 중...</div>

  <div class="controls">
    <select onchange="loadChart(this.value)">
      <option value="57_119">화성시 남양읍</option>
      <option value="62_114">평택시 비전동</option>
    </select>
  </div>

  <div class="chart-row">
    <canvas id="tempHwaseong"></canvas>
    <canvas id="feelsHwaseong"></canvas>
  </div>

  <img src="legend.png" class="legend" alt="범례">

  <p style="max-width: 600px; text-align: left; margin: 20px auto; font-size: 16px;">
    ※ <strong>일 최고체감온도</strong>는 시간대별 체감온도보다 더 높겠으니, 단계별 적극적인 대비가 필요합니다.<br>
    <strong>[주의]</strong> 야외작업은 가급적 자제하시기 바랍니다.<br>
    <strong>[경고]</strong> 야외작업은 피하시기 바랍니다.<br>
    <strong>[위험]</strong> 야외작업은 매우 위험합니다.
  </p>

  <img src="ci.png" class="ci" alt="기상청 CI">

  <script>
    const API_KEY = "(여기에 기상청 API Key 입력)";
    const API_URL = "https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst";

    const today = new Date();
    const tomorrow = new Date();
    tomorrow.setDate(today.getDate() + 1);
    const baseDate = today.toISOString().slice(0,10).replace(/-/g, "");
    const targetDate = tomorrow.toISOString().slice(0,10).replace(/-/g, "");

    document.getElementById("dateDisplay").innerText = `${baseDate.slice(4,6)}월 ${baseDate.slice(6,8)}일 17시 발표`;

    function getColor(temp) {
      if (temp >= 35) return "#E0002B";
      if (temp >= 33) return "#EF5D20";
      if (temp >= 31) return "#FFCD12";
      if (temp >= 29) return "#86E57F";
      return "#D5D5D5";
    }

    async function fetchData(nx, ny) {
      const url = `${API_URL}?serviceKey=${API_KEY}&numOfRows=1000&pageNo=1&dataType=JSON&base_date=${baseDate}&base_time=1700&nx=${nx}&ny=${ny}`;
      const res = await fetch(url);
      const data = await res.json();
      const items = data.response.body.items.item;

      let temps = {}, humids = {};
      items.forEach(item => {
        if (item.fcstDate === targetDate) {
          const time = parseInt(item.fcstTime);
          if (item.category === "TMP") temps[time] = parseFloat(item.fcstValue);
          if (item.category === "REH") humids[time] = parseFloat(item.fcstValue);
        }
      });

      let hours = [], tArr = [], fArr = [];
      for (let h = 800; h <= 2000; h += 100) {
        if (temps[h] && humids[h]) {
          hours.push(h.toString().padStart(4, '0'));
          tArr.push(temps[h]);
          const Tw = temps[h] * Math.atan(0.151977 * Math.pow(humids[h] + 8.313659, 0.5)) + Math.atan(temps[h] + humids[h]) - Math.atan(humids[h] - 1.67633) + 0.00391838 * Math.pow(humids[h], 1.5) * Math.atan(0.023101 * humids[h]) - 4.686035;
          const feels = -0.2442 + 0.55399 * Tw + 0.45535 * temps[h] - 0.0022 * Tw * Tw + 0.00278 * Tw * temps[h] + 3.0;
          fArr.push(Math.round(feels));
        }
      }

      return { hours, tArr, fArr };
    }

    function drawChart(id, labels, data, title) {
      const ctx = document.getElementById(id);
      if (!ctx) return;
      if (Chart.getChart(ctx)) Chart.getChart(ctx).destroy();

      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            label: title,
            data: new Array(labels.length).fill(1),
            backgroundColor: data.map(getColor),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          cutout: '60%',
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false },
            title: { display: true, text: title }
          }
        }
      });
    }

    async function loadChart(value) {
      const [nx, ny] = value.split("_");
      const { hours, tArr, fArr } = await fetchData(nx, ny);
      drawChart("tempHwaseong", hours, tArr, "기온");
      drawChart("feelsHwaseong", hours, fArr, "체감온도");
    }

    window.onload = () => loadChart("57_119");
  </script>
</body>
</html>

