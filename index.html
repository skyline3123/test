<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í™”ì„±Â·í‰íƒ ì‹œê°„ëŒ€ë³„ ì²´ê°ì˜¨ë„ ì˜ˆë³´</title>

  <!-- Chart.js v4 ê³ ì • ë¡œë“œ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Google Webfont (Jua) -->
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet" />

  <style>
    /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
    body {
      font-family: 'Jua', sans-serif;
      margin: 0;
      padding: 20px;
      text-align: center;
      background: #F0F8FF;
    }

    h1 {
      font-size: min(7vw, 40px);
      margin: 0 0 20px;
    }

    /* ë“œë¡­ë‹¤ìš´ ì»¨í…Œì´ë„ˆ */
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    select {
      width: 100%;
      max-width: 180px;
      height: 40px;
      font-size: 16px;
    }

    /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ (ë°˜ì‘í˜•) */
    .chart-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }

    canvas {
      width: 46vw;   /* ëª¨ë°”ì¼ì—ì„œ 2ê°œ ë‚˜ë€íˆ â†’ 46% */
      max-width: 200px;
      height: auto;
    }

    /* ë…¸íŠ¸ */
    .note {
      font-size: 15px;
      max-width: 600px;
      margin: 20px auto 0;
      text-align: left;
      line-height: 1.4em;
    }
  </style>
</head>
<body>
  <h1>ğŸŒ¡ ë‚´ì¼ ì‹œê°„ëŒ€ë³„ ì²´ê°ì˜¨ë„ ì˜ˆë³´</h1>
  <div id="dateDisplay">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <!-- =================  ë“œë¡­ë‹¤ìš´  ================= -->
  <div class="controls">
    <select id="locationS" onchange="selectS(this.value)">
      <option value="hwaseong">í™”ì„±ì‹œ</option>
      <option value="pyeongtaek">í‰íƒì‹œ</option>
    </select>

    <!-- í™”ì„± ìë©´ë™ -->
    <select id="locationD_H" onchange="selectD(this.value)">
      <option value="57_119">ë‚¨ì–‘ì</option>
      <option value="62_119">ë™íƒ„2ë™</option>
    </select>

    <!-- í‰íƒ ìë©´ë™ (ì´ˆê¸° ìˆ¨ê¹€) -->
    <select id="locationD_P" style="display:none;" onchange="selectD(this.value)">
      <option value="62_114">ë¹„ì „1ë™</option>
      <option value="61_114">íŒ½ì„±ì</option>
    </select>
  </div>

  <!-- ë²”ë¡€ ì´ë¯¸ì§€ (ì›í•œë‹¤ë©´ ì˜ë¬¸ íŒŒì¼ëª… legend.png ë¡œ ë³€ê²½) -->
  <img src="legend.png" alt="ë²”ë¡€" style="width:280px; max-width:80%; margin:10px auto;" />

  <!-- =================  ì°¨íŠ¸ ì˜ì—­  ================= -->
  <div class="chart-row">
    <canvas id="tempChart"></canvas>
    <canvas id="feelsChart"></canvas>
  </div>

  <div class="note">
    â€» <strong>ì¼ ìµœê³ ì²´ê°ì˜¨ë„</strong>ëŠ” ì‹œê°„ëŒ€ë³„ ì²´ê°ì˜¨ë„ë³´ë‹¤ ë” ë†’ìœ¼ë¯€ë¡œ ë‹¨ê³„ë³„ ëŒ€ì‘ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
    [ì£¼ì˜] ì•¼ì™¸ì‘ì—…ì€ ê°€ê¸‰ì  ìì œí•˜ì„¸ìš”.<br>
    [ê²½ê³ ] ê°€ëŠ¥í•˜ë‹¤ë©´ ì•¼ì™¸ì‘ì—…ì„ í”¼í•˜ì„¸ìš”.<br>
    [ìœ„í—˜] ì•¼ì™¸ì‘ì—…ì€ ë§¤ìš° ìœ„í—˜í•©ë‹ˆë‹¤.
  </div>

  <script>
    /* =================  ê¸°ë³¸ ë‚ ì§œ ì„¸íŒ…  ================= */
    const today = new Date();
    const tomorrow = new Date();
    tomorrow.setDate(today.getDate() + 1);
    const baseDate = today.toISOString().slice(0, 10).replace(/-/g, "");
    const fcstDate = tomorrow.toISOString().slice(0, 10).replace(/-/g, "");
    document.getElementById('dateDisplay').innerText = `${baseDate.substr(4,2)}ì›” ${baseDate.substr(6,2)}ì¼ 17ì‹œ ë°œí‘œ`;

    /* =================  ìœ„ì¹˜ ì„ íƒ ë¡œì§  ================= */
    function selectS(city) {
      if (city === 'hwaseong') {
        document.getElementById('locationD_H').style.display = 'inline-block';
        document.getElementById('locationD_P').style.display = 'none';
        loadCharts(57, 119);
      } else {
        document.getElementById('locationD_H').style.display = 'none';
        document.getElementById('locationD_P').style.display = 'inline-block';
        loadCharts(62, 114);
      }
    }

    function selectD(value) {
      const [nx, ny] = value.split('_');
      loadCharts(nx, ny);
    }

    /* =================  ê³µê³µë°ì´í„°í¬í„¸ API  ================= */
    const API_KEY = "ì—¬ê¸°ì—_ì„œë¹„ìŠ¤í‚¤_ì…ë ¥"; // URL ì¸ì½”ë”© X ìƒíƒœ
    const API_URL = "https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst";

    async function fetchForecast(nx, ny) {
      const url = `${API_URL}?serviceKey=${API_KEY}&numOfRows=1000&pageNo=1&dataType=JSON&base_date=${baseDate}&base_time=1700&nx=${nx}&ny=${ny}`;
      const res = await fetch(url);
      const data = await res.json();
      const items = data.response.body.items.item;

      const temp = new Map();
      const humid = new Map();
      items.forEach(item => {
        if (item.fcstDate !== fcstDate) return;
        const hh = parseInt(item.fcstTime);
        if (hh < 800 || hh > 2000) return;
        if (item.category === 'TMP') temp.set(hh, +item.fcstValue);
        if (item.category === 'REH') humid.set(hh, +item.fcstValue);
      });

      const times = [], tArr = [], hArr = [];
      for (let hh=800; hh<=2000; hh+=100) {
        if (temp.has(hh) && humid.has(hh)) {
          times.push(hh.toString().padStart(4,'0'));
          tArr.push(temp.get(hh));
          hArr.push(humid.get(hh));
        }
      }

      const feels = tArr.map((Ta,i)=>{
        const RH = hArr[i];
        const Tw = calcWetBulb(Ta,RH);
        return Math.round(calcFeels(Ta,Tw));
      });
      return {times, tArr, feels};
    }

    /* =================  ì²´ê°ì˜¨ë„ ê³„ì‚°ì‹  ================= */
    function calcWetBulb(Ta,RH){
      return Ta*Math.atan(0.151977*Math.sqrt(RH+8.313659))+
             Math.atan(Ta+RH)-Math.atan(RH-1.67633)+
             0.00391838*Math.pow(RH,1.5)*Math.atan(0.023101*RH)-4.686035;
    }
    function calcFeels(Ta,Tw){
      return -0.2442+0.55399*Tw+0.45535*Ta-0.0022*Tw*Tw+0.00278*Tw*Ta+3.0;
    }

    /* =================  ì°¨íŠ¸ ê·¸ë¦¬ê¸°  ================= */
    function colorScale(v){
      if(v>=35) return '#E0002B';
      if(v>=33) return '#EF5D20';
      if(v>=31) return '#FFCD12';
      if(v>=29) return '#86E57F';
      return '#D5D5D5';
    }

    let tempChartInst=null, feelsChartInst=null;
    function drawDoughnut(ctxId, labels, values, title){
      const data = values.map(()=>1);
      data.push(0.15); // padding slice
      const labelsExt = [...labels,''];
      const bg = values.map(colorScale);
      bg.push('rgba(0,0,0,0)');

      if(Chart.getChart(ctxId)) Chart.getChart(ctxId).destroy();
      return new Chart(ctxId, {
        type:'doughnut',
        data:{
          labels:labelsExt,
          datasets:[{data,borderWidth:1,backgroundColor:bg,realValues:values}]
        },
        options:{
          rotation:235,
          cutout:'55%',
          plugins:{legend:{display:false},tooltip:{enabled:false},title:{display:true,text:title,font:{size:16}}}
        }
      });
    }

    async function loadCharts(nx,ny){
      const {times,tArr,feels} = await fetchForecast(nx,ny);
      const labDate = `${fcstDate.substr(4,2)}/${fcstDate.substr(6,2)}`;
      tempChartInst = drawDoughnut('tempChart', times, tArr, `${labDate} ê¸°ì˜¨`);
      feelsChartInst = drawDoughnut('feelsChart', times, feels, `${labDate} ì²´ê°ì˜¨ë„`);
    }

    /* =================  ì²« ë¡œë”©  ================= */
    window.addEventListener('load',()=>loadCharts(57,119));
  </script>
</body>
</html>
